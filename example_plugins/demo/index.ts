import { BasePlugin, PluginAPI, PluginMetadata } from '@/plugins/core'
import DemoWidget from './components/DemoWidget.vue'
import DemoPage from './components/DemoPage.vue'
import DemoModal from './components/DemoModal.vue'

export default class DemoPlugin extends BasePlugin {
  private menuItemId?: string
  private shortcutRegistered = false
  private themeRegistered = false
  private storageWatcher?: () => void

  constructor(metadata: PluginMetadata, api: PluginAPI) {
    super(metadata, api)
  }

  async onActivate(): Promise<void> {
    console.log('üöÄ Demo Plugin activated!')
    
    try {
      // 1. Ê≥®ÂÜåËèúÂçïÈ°π
      this.registerMenuItems()
      
      // 2. Ê≥®ÂÜåÁΩëÊ†ºÈ°πÁõÆÁ±ªÂûã
      this.registerGridItems()
      
      // 3. Ê≥®ÂÜåÂø´Êç∑ÈîÆ
      this.registerShortcuts()
      
      // 4. Ê≥®ÂÜåÈ°µÈù¢
      this.registerPages()
      
      // 5. Ê≥®ÂÜå‰∏ªÈ¢ò
      this.registerTheme()
      
      // 6. ËÆæÁΩÆÂ≠òÂÇ®ÁõëÂê¨
      this.setupStorageWatcher()
      
      // 7. ÊòæÁ§∫ÊøÄÊ¥ªÈÄöÁü•
      this.api.notifications.show(
        'Êèí‰ª∂Á§∫‰æãÂ∑≤ÊøÄÊ¥ªÔºÅÊåâ Ctrl+Shift+D ÊâìÂºÄÊºîÁ§∫',
        'success',
        {
          duration: 5000,
          actions: [
            {
              label: 'Êü•ÁúãÊºîÁ§∫',
              action: () => this.showDemoModal()
            }
          ]
        }
      )
      
    } catch (error) {
      console.error('Demo Plugin activation failed:', error)
      this.api.notifications.show('Êèí‰ª∂Á§∫‰æãÊøÄÊ¥ªÂ§±Ë¥•', 'error')
      throw error
    }
  }

  async onDeactivate(): Promise<void> {
    console.log('üõë Demo Plugin deactivated!')
    
    try {
      // Ê∏ÖÁêÜËèúÂçïÈ°π
      if (this.menuItemId) {
        this.api.menu.removeMenuItem(this.menuItemId)
      }

      // Ê∏ÖÁêÜÂø´Êç∑ÈîÆ
      if (this.shortcutRegistered) {
        this.api.shortcuts.unregisterAll()
      }

      // Ê∏ÖÁêÜÁΩëÊ†ºÈ°πÁõÆÁ±ªÂûã
      this.api.grid.unregisterItemType('demo-widget')

      // Ê∏ÖÁêÜÈ°µÈù¢
      this.api.page.unregisterPage('demo-page')

      // Ê∏ÖÁêÜ‰∏ªÈ¢ò
      if (this.themeRegistered) {
        this.api.theme.deactivate('demo-theme')
      }

      // Ê∏ÖÁêÜÂ≠òÂÇ®ÁõëÂê¨
      if (this.storageWatcher) {
        this.storageWatcher()
      }

      this.api.notifications.show('Êèí‰ª∂Á§∫‰æãÂ∑≤ÂÅúÁî®', 'info')
      
    } catch (error) {
      console.error('Demo Plugin deactivation failed:', error)
    }
  }

  private registerMenuItems() {
    this.menuItemId = this.api.menu.addMenuItem({
      id: 'demo-plugin-menu',
      label: 'Êèí‰ª∂Á§∫‰æã',
      icon: 'pi pi-star',
      submenu: [
        {
          id: 'demo-widget-action',
          label: 'Ê∑ªÂä†ÊºîÁ§∫ÁªÑ‰ª∂',
          icon: 'pi pi-plus',
          action: () => this.addDemoWidget()
        },
        {
          id: 'demo-page-action',
          label: 'ÊâìÂºÄÊºîÁ§∫È°µÈù¢',
          icon: 'pi pi-window-maximize',
          action: () => this.openDemoPage()
        },
        {
          id: 'demo-theme-action',
          label: 'ÂàáÊç¢ÊºîÁ§∫‰∏ªÈ¢ò',
          icon: 'pi pi-palette',
          action: () => this.toggleDemoTheme()
        },
        {
          id: 'demo-storage-action',
          label: 'Â≠òÂÇ®ÊºîÁ§∫',
          icon: 'pi pi-database',
          action: () => this.demonstrateStorage()
        },
        {
          id: 'demo-notifications-action',
          label: 'ÈÄöÁü•ÊºîÁ§∫',
          icon: 'pi pi-bell',
          action: () => this.demonstrateNotifications()
        }
      ]
    })
  }

  private registerGridItems() {
    this.api.grid.registerItemType(
      'demo-widget',
      DemoWidget,
      (data) => data && typeof data.title === 'string',
      {
        title: 'ÊºîÁ§∫ÁªÑ‰ª∂',
        content: 'ËøôÊòØ‰∏Ä‰∏™Êèí‰ª∂ÊºîÁ§∫ÁªÑ‰ª∂',
        color: '#3B82F6',
        counter: 0
      }
    )
  }

  private registerShortcuts() {
    // ‰∏ªÊºîÁ§∫Âø´Êç∑ÈîÆ
    this.api.shortcuts.register('ctrl+shift+d', () => {
      this.showDemoModal()
    })

    // Âø´ÈÄüÊ∑ªÂä†ÁªÑ‰ª∂
    this.api.shortcuts.register('ctrl+alt+w', () => {
      this.addDemoWidget()
    })

    // ÈÄöÁü•ÊºîÁ§∫
    this.api.shortcuts.register('ctrl+alt+n', () => {
      this.demonstrateNotifications()
    })

    this.shortcutRegistered = true
  }

  private registerPages() {
    this.api.page.registerPage('demo-page', DemoPage, {
      title: 'Êèí‰ª∂ÊºîÁ§∫È°µÈù¢',
      description: 'Â±ïÁ§∫Êèí‰ª∂Á≥ªÁªüÂäüËÉΩÁöÑÊºîÁ§∫È°µÈù¢',
      icon: 'pi pi-star',
    })
  }

  private registerTheme() {
    this.api.theme.register({
      name: 'demo-theme',
      mode: 'auto',
      cssVariables: {
        'demo-primary': 'light-dark(#3B82F6, #60A5FA)',
        'demo-secondary': 'light-dark(#10B981, #34D399)',
        'demo-accent': 'light-dark(#F59E0B, #FBBF24)',
        'demo-background': 'light-dark(#FFFFFF, #1F2937)',
        'demo-surface': 'light-dark(#F9FAFB, #374151)',
        'demo-text': 'light-dark(#111827, #F9FAFB)',
        'demo-border': 'light-dark(#E5E7EB, #4B5563)',
      },
      styles: {
        '.demo-widget': `
          background: var(--demo-background);
          color: var(--demo-text);
          border: 2px solid var(--demo-border);
          border-radius: 12px;
          transition: all 0.3s ease;
        `,
        '.demo-widget:hover': `
          border-color: var(--demo-primary);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        `,
        '.demo-page': `
          background: linear-gradient(135deg, var(--demo-primary), var(--demo-secondary));
          min-height: 100vh;
        `
      }
    })
    this.themeRegistered = true
  }

  private setupStorageWatcher() {
    // ÁõëÂê¨Â≠òÂÇ®ÂèòÂåñ
    this.storageWatcher = this.api.storage.watch('demo-counter', (value) => {
      console.log('Demo counter changed:', value)
      this.api.notifications.show(
        `ËÆ°Êï∞Âô®Êõ¥Êñ∞‰∏∫: ${value || 0}`,
        'info',
        { duration: 2000 }
      )
    })
  }

  private async addDemoWidget() {
    try {
      const counter = await this.api.storage.get('demo-widget-count') || 0
      const newCount = counter + 1
      
      await this.api.grid.addItem({
        type: 'demo-widget',
        data: {
          title: `ÊºîÁ§∫ÁªÑ‰ª∂ #${newCount}`,
          content: `ËøôÊòØÁ¨¨ ${newCount} ‰∏™ÊºîÁ§∫ÁªÑ‰ª∂`,
          color: this.getRandomColor(),
          counter: newCount
        }
      })
      
      await this.api.storage.set('demo-widget-count', newCount)
      
      this.api.notifications.show(
        `Â∑≤Ê∑ªÂä†ÊºîÁ§∫ÁªÑ‰ª∂ #${newCount}`,
        'success'
      )
    } catch (error) {
      console.error('Failed to add demo widget:', error)
      this.api.notifications.show('Ê∑ªÂä†ÁªÑ‰ª∂Â§±Ë¥•', 'error')
    }
  }

  private openDemoPage() {
    this.api.page.activate('demo-page')
    this.api.notifications.show('Â∑≤ÊâìÂºÄÊºîÁ§∫È°µÈù¢', 'success')
  }

  private toggleDemoTheme() {
    if (this.api.theme.isActive('demo-theme')) {
      this.api.theme.deactivate('demo-theme')
      this.api.notifications.show('Â∑≤ÂÖ≥Èó≠ÊºîÁ§∫‰∏ªÈ¢ò', 'info')
    } else {
      this.api.theme.activate('demo-theme')
      this.api.notifications.show('Â∑≤ÊøÄÊ¥ªÊºîÁ§∫‰∏ªÈ¢ò', 'success')
    }
  }

  private async demonstrateStorage() {
    try {
      const currentValue = await this.api.storage.get('demo-counter') || 0
      const newValue = currentValue + 1
      
      await this.api.storage.set('demo-counter', newValue)
      
      const allData = {
        counter: newValue,
        timestamp: new Date().toISOString(),
        pluginId: this.metadata.id
      }
      
      await this.api.storage.set('demo-data', allData)
      
      this.api.notifications.show(
        `Â≠òÂÇ®ÊºîÁ§∫ÂÆåÊàêÔºÅËÆ°Êï∞Âô®: ${newValue}`,
        'success',
        {
          actions: [
            {
              label: 'Êü•ÁúãÊï∞ÊçÆ',
              action: async () => {
                const data = await this.api.storage.get('demo-data')
                console.log('Demo storage data:', data)
                this.api.notifications.show(
                  `Â≠òÂÇ®Êï∞ÊçÆ: ${JSON.stringify(data, null, 2)}`,
                  'info',
                  { duration: 8000 }
                )
              }
            }
          ]
        }
      )
    } catch (error) {
      console.error('Storage demonstration failed:', error)
      this.api.notifications.show('Â≠òÂÇ®ÊºîÁ§∫Â§±Ë¥•', 'error')
    }
  }

  private demonstrateNotifications() {
    const notifications = [
      { type: 'info', message: 'ËøôÊòØ‰∏Ä‰∏™‰ø°ÊÅØÈÄöÁü•' },
      { type: 'success', message: 'ËøôÊòØ‰∏Ä‰∏™ÊàêÂäüÈÄöÁü•' },
      { type: 'warning', message: 'ËøôÊòØ‰∏Ä‰∏™Ë≠¶ÂëäÈÄöÁü•' },
      { type: 'error', message: 'ËøôÊòØ‰∏Ä‰∏™ÈîôËØØÈÄöÁü•' }
    ] as const

    let index = 0
    const showNext = () => {
      if (index < notifications.length) {
        const notif = notifications[index]
        this.api.notifications.show(
          notif.message,
          notif.type,
          {
            duration: 3000,
            actions: index === notifications.length - 1 ? [] : [
              {
                label: '‰∏ã‰∏Ä‰∏™',
                action: () => {
                  index++
                  setTimeout(showNext, 500)
                }
              }
            ]
          }
        )
        if (index === 0) {
          index++
          setTimeout(showNext, 3500)
        }
      }
    }

    showNext()
  }

  private showDemoModal() {
    // ËøôÈáåÂèØ‰ª•Ëß¶ÂèëÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÁöÑÈÄªËæë
    console.log('Show demo modal')
    this.api.notifications.show(
      'ÊºîÁ§∫Ê®°ÊÄÅÊ°ÜÂäüËÉΩÔºàÂºÄÂèë‰∏≠Ôºâ',
      'info',
      {
        actions: [
          {
            label: '‰∫ÜËß£Êõ¥Â§ö',
            action: () => {
              console.log('Learn more about demo plugin')
            }
          }
        ]
      }
    )
  }

  private getRandomColor(): string {
    const colors = [
      '#3B82F6', '#EF4444', '#10B981', '#F59E0B',
      '#8B5CF6', '#06B6D4', '#84CC16', '#F97316',
      '#EC4899', '#6366F1'
    ]
    return colors[Math.floor(Math.random() * colors.length)]
  }

  // ÂÖ¨ÂÖ±ÊñπÊ≥ï‰æõÂ§ñÈÉ®Ë∞ÉÁî®
  public async getPluginInfo() {
    return {
      metadata: this.metadata,
      state: this.getState(),
      statistics: {
        widgetsCreated: await this.api.storage.get('demo-widget-count') || 0,
        counterValue: await this.api.storage.get('demo-counter') || 0,
        isThemeActive: this.api.theme.isActive('demo-theme')
      }
    }
  }
}
