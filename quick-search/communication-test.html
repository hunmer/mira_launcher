<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>通信系统集成测试</title>
  <link rel="stylesheet" href="theme-system.css">
  <link rel="stylesheet" href="component-integration.css">
  <script src="https://unpkg.com/vue@3.4.29/dist/vue.global.js"></script>
</head>
<body>
  <div id="app">
    <div class="test-container">
      <h1>通信系统测试</h1>
      
      <!-- 环境状态显示 -->
      <div class="status-section">
        <h2>环境状态</h2>
        <div class="status-grid">
          <div class="status-item">
            <label>运行环境:</label>
            <span :class="environmentClass">{{ environmentType }}</span>
          </div>
          <div class="status-item">
            <label>通信状态:</label>
            <span :class="communicationStatusClass">{{ communicationStatus }}</span>
          </div>
          <div class="status-item">
            <label>事件监听器:</label>
            <span>{{ listenerCount }} 个活跃</span>
          </div>
        </div>
      </div>

      <!-- 搜索测试 -->
      <div class="search-section">
        <h2>搜索功能测试</h2>
        <div class="search-controls">
          <input 
            v-model="searchQuery" 
            @input="onSearchInput" 
            placeholder="输入搜索关键词..." 
            class="search-input"
          >
          <button @click="performSearch" class="btn btn-primary">执行搜索</button>
          <button @click="clearResults" class="btn btn-secondary">清除结果</button>
        </div>
        
        <div v-if="searchResults.length > 0" class="results-container">
          <h3>搜索结果 ({{ searchResults.length }} 项)</h3>
          <div class="results-list">
            <div 
              v-for="(result, index) in searchResults" 
              :key="index"
              class="result-item"
              @click="openApplication(result)"
            >
              <div class="result-icon">
                <img :src="result.icon || 'icons/placeholder.svg'" :alt="result.name">
              </div>
              <div class="result-content">
                <div class="result-name">{{ result.name }}</div>
                <div class="result-path">{{ result.path || result.description }}</div>
              </div>
              <div class="result-actions">
                <button @click.stop="showInFinder(result)" class="btn-action">显示</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 事件测试 -->
      <div class="events-section">
        <h2>事件通信测试</h2>
        <div class="event-controls">
          <button @click="testWindowEvents" class="btn btn-primary">测试窗口事件</button>
          <button @click="testSearchEvents" class="btn btn-primary">测试搜索事件</button>
          <button @click="testThemeEvents" class="btn btn-primary">测试主题事件</button>
          <button @click="clearEventLog" class="btn btn-secondary">清除日志</button>
        </div>
        
        <div class="event-log" ref="eventLog">
          <div 
            v-for="(event, index) in eventHistory" 
            :key="index"
            :class="['event-entry', `event-${event.type}`]"
          >
            <span class="event-time">{{ formatTime(event.timestamp) }}</span>
            <span class="event-type">{{ event.type }}</span>
            <span class="event-data">{{ event.data }}</span>
          </div>
        </div>
      </div>

      <!-- 调试信息 -->
      <div class="debug-section">
        <h2>调试信息</h2>
        <div class="debug-grid">
          <div class="debug-item">
            <label>Tauri 版本:</label>
            <span>{{ tauriVersion || '未检测到' }}</span>
          </div>
          <div class="debug-item">
            <label>Vue 版本:</label>
            <span>{{ vueVersion }}</span>
          </div>
          <div class="debug-item">
            <label>浏览器:</label>
            <span>{{ browserInfo }}</span>
          </div>
          <div class="debug-item">
            <label>平台:</label>
            <span>{{ platformInfo }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="communication-bridge.js"></script>
  <script src="vue-communication-adapter.js"></script>
  <script src="theme-manager.js"></script>
  
  <script>
    const { createApp, ref, reactive, onMounted, computed, nextTick } = window.Vue
    
    const app = createApp({
      setup() {
        // 状态管理
        const searchQuery = ref('')
        const searchResults = ref([])
        const eventHistory = ref([])
        const communicationStatus = ref('initializing')
        const listenerCount = ref(0)
        const eventLog = ref(null)
        
        // 通信桥接
        let communicationBridge = null
        
        // 计算属性
        const environmentType = computed(() => {
          if (typeof window !== 'undefined' && window.__TAURI__) {
            return 'Tauri App'
          }
          return 'Web Browser'
        })
        
        const environmentClass = computed(() => ({
          'status-tauri': environmentType.value === 'Tauri App',
          'status-web': environmentType.value === 'Web Browser'
        }))
        
        const communicationStatusClass = computed(() => ({
          'status-connected': communicationStatus.value === 'connected',
          'status-connecting': communicationStatus.value === 'connecting',
          'status-error': communicationStatus.value === 'error'
        }))
        
        const vueVersion = computed(() => window.Vue?.version || '3.4.29')
        
        const tauriVersion = computed(() => {
          if (window.__TAURI__?.tauri) {
            return window.__TAURI__.tauri.version || 'Unknown'
          }
          return null
        })
        
        const browserInfo = computed(() => {
          return navigator.userAgent.split(' ').slice(-2).join(' ')
        })
        
        const platformInfo = computed(() => {
          return navigator.platform || 'Unknown'
        })
        
        // 搜索功能
        const onSearchInput = () => {
          if (searchQuery.value.trim() === '') {
            searchResults.value = []
            return
          }
          
          // 模拟搜索延迟
          setTimeout(() => {
            performSearch()
          }, 300)
        }
        
        const performSearch = async () => {
          if (!communicationBridge || searchQuery.value.trim() === '') {
            return
          }
          
          logEvent('search', `搜索: ${searchQuery.value}`)
          
          try {
            const results = await communicationBridge.searchApplications(searchQuery.value)
            searchResults.value = results || []
            logEvent('search-result', `找到 ${searchResults.value.length} 个结果`)
          } catch (error) {
            logEvent('error', `搜索失败: ${error.message}`)
            // 使用模拟数据作为后备
            searchResults.value = generateMockResults(searchQuery.value)
          }
        }
        
        const clearResults = () => {
          searchQuery.value = ''
          searchResults.value = []
          logEvent('action', '清除搜索结果')
        }
        
        const openApplication = async (app) => {
          if (!communicationBridge) {
            return
          }
          
          logEvent('action', `打开应用: ${app.name}`)
          
          try {
            await communicationBridge.launchApplication(app.path || app.name)
            logEvent('success', `成功启动: ${app.name}`)
          } catch (error) {
            logEvent('error', `启动失败: ${error.message}`)
          }
        }
        
        const showInFinder = async (app) => {
          if (!communicationBridge) {
            return
          }
          
          logEvent('action', `在Finder中显示: ${app.name}`)
          
          try {
            await communicationBridge.showInFinder(app.path)
            logEvent('success', `已在Finder中显示: ${app.name}`)
          } catch (error) {
            logEvent('error', `显示失败: ${error.message}`)
          }
        }
        
        // 事件测试
        const testWindowEvents = async () => {
          if (!communicationBridge) {
            return
          }
          
          logEvent('test', '测试窗口事件')
          
          try {
            await communicationBridge.emit('window-focus')
            await communicationBridge.emit('window-blur')
            await communicationBridge.emit('window-minimize')
            logEvent('success', '窗口事件测试完成')
          } catch (error) {
            logEvent('error', `窗口事件测试失败: ${error.message}`)
          }
        }
        
        const testSearchEvents = async () => {
          if (!communicationBridge) {
            return
          }
          
          logEvent('test', '测试搜索事件')
          
          try {
            await communicationBridge.emit('search-query-changed', { query: 'test' })
            await communicationBridge.emit('search-results-updated', { count: 5 })
            logEvent('success', '搜索事件测试完成')
          } catch (error) {
            logEvent('error', `搜索事件测试失败: ${error.message}`)
          }
        }
        
        const testThemeEvents = async () => {
          if (!communicationBridge) {
            return
          }
          
          logEvent('test', '测试主题事件')
          
          try {
            await communicationBridge.emit('theme-changed', { theme: 'dark' })
            await communicationBridge.emit('settings-updated', { setting: 'theme', value: 'light' })
            logEvent('success', '主题事件测试完成')
          } catch (error) {
            logEvent('error', `主题事件测试失败: ${error.message}`)
          }
        }
        
        const clearEventLog = () => {
          eventHistory.value = []
          logEvent('action', '清除事件日志')
        }
        
        // 工具函数
        const logEvent = (type, data) => {
          const event = {
            type,
            data,
            timestamp: new Date()
          }
          eventHistory.value.unshift(event)
          
          // 限制日志数量
          if (eventHistory.value.length > 100) {
            eventHistory.value = eventHistory.value.slice(0, 100)
          }
          
          // 自动滚动到顶部
          nextTick(() => {
            if (eventLog.value) {
              eventLog.value.scrollTop = 0
            }
          })
        }
        
        const formatTime = (timestamp) => {
          return timestamp.toLocaleTimeString()
        }
        
        const generateMockResults = (query) => {
          const mockApps = [
            { name: 'Visual Studio Code', path: '/Applications/Visual Studio Code.app', icon: 'icons/vscode.svg' },
            { name: 'Chrome', path: '/Applications/Google Chrome.app', icon: 'icons/chrome.svg' },
            { name: 'Figma', path: '/Applications/Figma.app', icon: 'icons/figma.svg' },
            { name: 'Notion', path: '/Applications/Notion.app', icon: 'icons/notion.svg' },
            { name: 'Slack', path: '/Applications/Slack.app', icon: 'icons/slack.svg' }
          ]
          
          return mockApps.filter(app => 
            app.name.toLowerCase().includes(query.toLowerCase())
          )
        }
        
        // 初始化
        const initializeCommunication = async () => {
          try {
            communicationStatus.value = 'connecting'
            logEvent('system', '初始化通信系统')
            
            communicationBridge = new window.CommunicationBridge()
            
            // 注册事件监听器
            const events = [
              'application-launched',
              'search-data-updated',
              'theme-changed',
              'window-focused',
              'window-blurred'
            ]
            
            events.forEach(eventName => {
              communicationBridge.on(eventName, (data) => {
                logEvent('received', `${eventName}: ${JSON.stringify(data)}`)
              })
            })
            
            listenerCount.value = events.length
            communicationStatus.value = 'connected'
            logEvent('system', '通信系统初始化完成')
            
          } catch (error) {
            communicationStatus.value = 'error'
            logEvent('error', `初始化失败: ${error.message}`)
          }
        }
        
        // 生命周期
        onMounted(async () => {
          await initializeCommunication()
          logEvent('system', '页面加载完成')
        })
        
        return {
          // 状态
          searchQuery,
          searchResults,
          eventHistory,
          communicationStatus,
          listenerCount,
          eventLog,
          
          // 计算属性
          environmentType,
          environmentClass,
          communicationStatusClass,
          vueVersion,
          tauriVersion,
          browserInfo,
          platformInfo,
          
          // 方法
          onSearchInput,
          performSearch,
          clearResults,
          openApplication,
          showInFinder,
          testWindowEvents,
          testSearchEvents,
          testThemeEvents,
          clearEventLog,
          formatTime
        }
      }
    })
    
    app.mount('#app')
  </script>
  
  <style>
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .status-section,
    .search-section,
    .events-section,
    .debug-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--surface-card);
      border-radius: var(--border-radius);
      border: 1px solid var(--surface-border);
    }
    
    .status-grid,
    .debug-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .status-item,
    .debug-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: var(--surface-ground);
      border-radius: var(--border-radius);
    }
    
    .status-item label,
    .debug-item label {
      font-weight: 600;
      color: var(--text-color-secondary);
    }
    
    .status-tauri {
      color: var(--green-500);
      font-weight: 600;
    }
    
    .status-web {
      color: var(--blue-500);
      font-weight: 600;
    }
    
    .status-connected {
      color: var(--green-500);
      font-weight: 600;
    }
    
    .status-connecting {
      color: var(--orange-500);
      font-weight: 600;
    }
    
    .status-error {
      color: var(--red-500);
      font-weight: 600;
    }
    
    .search-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 0.75rem;
      border: 1px solid var(--surface-border);
      border-radius: var(--border-radius);
      background: var(--surface-ground);
      color: var(--text-color);
      font-size: 1rem;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-light);
    }
    
    .results-container {
      margin-top: 1.5rem;
    }
    
    .results-list {
      display: grid;
      gap: 0.5rem;
    }
    
    .result-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--surface-ground);
      border-radius: var(--border-radius);
      border: 1px solid var(--surface-border);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .result-item:hover {
      background: var(--surface-hover);
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }
    
    .result-icon {
      width: 48px;
      height: 48px;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    
    .result-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .result-content {
      flex: 1;
    }
    
    .result-name {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }
    
    .result-path {
      font-size: 0.875rem;
      color: var(--text-color-secondary);
    }
    
    .result-actions {
      margin-left: 1rem;
    }
    
    .btn-action {
      padding: 0.5rem 1rem;
      background: var(--surface-100);
      border: 1px solid var(--surface-border);
      border-radius: var(--border-radius);
      color: var(--text-color);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .btn-action:hover {
      background: var(--surface-200);
      border-color: var(--primary-color);
    }
    
    .event-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .event-log {
      max-height: 400px;
      overflow-y: auto;
      background: var(--surface-ground);
      border: 1px solid var(--surface-border);
      border-radius: var(--border-radius);
      padding: 1rem;
    }
    
    .event-entry {
      display: grid;
      grid-template-columns: auto auto 1fr;
      gap: 1rem;
      padding: 0.5rem;
      border-bottom: 1px solid var(--surface-border);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    
    .event-entry:last-child {
      border-bottom: none;
    }
    
    .event-time {
      color: var(--text-color-secondary);
      white-space: nowrap;
    }
    
    .event-type {
      font-weight: 600;
      white-space: nowrap;
    }
    
    .event-data {
      color: var(--text-color);
      word-break: break-all;
    }
    
    .event-system .event-type {
      color: var(--blue-500);
    }
    
    .event-success .event-type {
      color: var(--green-500);
    }
    
    .event-error .event-type {
      color: var(--red-500);
    }
    
    .event-test .event-type {
      color: var(--purple-500);
    }
    
    .event-action .event-type {
      color: var(--orange-500);
    }
    
    .event-received .event-type {
      color: var(--cyan-500);
    }
    
    .event-search .event-type {
      color: var(--teal-500);
    }
    
    .event-search-result .event-type {
      color: var(--indigo-500);
    }
  </style>
</body>
</html>
